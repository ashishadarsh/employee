
<p-table
    #dt1
    [value]="filteredTasks"
    [globalFilterFields]="['name', 'country.name', 'representative.name', 'status']"
    selectionMode="single"
    dataKey="_id"
    [tableStyle]="{ 'min-width': '50rem' }"
    [rows]="10"
    [paginator]="true"
    [rowsPerPageOptions]="[5,10,20]"
    stateStorage="session"
    stateKey="statedemo-session"
>
<ng-template pTemplate="caption">
  <div class="tasks-caption">

    <!-- Top-right: Search + Add Task -->
    <div class="search-actions-top">
      <p-iconfield iconPosition="left">
        <p-inputicon>
          <i class="pi pi-search"></i>
        </p-inputicon>
        <input
          pInputText
          type="text"
          placeholder="Search..."
          [(ngModel)]="searchTerm"
        />
      </p-iconfield>

      <p-button
        label="Add Task"
        icon="pi pi-plus"
        variant="outlined"
        [raised]="true"
        severity="info"
        [routerLink]="['/tasks/add']"
      ></p-button>
    </div>

    <!-- Centered Tabs -->
    <div class="custom-tabview-wrapper">
      <!-- <p-tabView
        [activeIndex]="archive() ? 1 : 0"
        (onChange)="onTabChange($event)"
        class="custom-tabview"
      >
        <p-tabPanel header="Active Tasks"></p-tabPanel>
        <p-tabPanel header="Archived Tasks"></p-tabPanel>
      </p-tabView> -->
      <p-tabView
        [activeIndex]="activeIndex"
        (onChange)="onTabChange($event)"
        class="custom-tabview"
      >
        <p-tabPanel header="Active Tasks"></p-tabPanel>
        <p-tabPanel header="Archived Tasks"></p-tabPanel>
        <p-tabPanel header="Backlog Tasks"></p-tabPanel>
      </p-tabView>

    </div>

    <div class="status-filter">
      <label>Status:</label>
      <select [(ngModel)]="selectedStatus">
        <option value="">All</option>
        <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
      </select>
    </div>

  </div>
</ng-template>


    <ng-template #header>
        <tr>
            <th pSortableColumn="name" style="width:35%; padding-left: 72px;">
                <div class="flex items-center gap-2">
                    Title
                    <p-sortIcon field="name" />
                </div>
            </th>
            <th style="width:5%">
              <div class="flex items-center gap-2">

              </div>
          </th>
            <th pSortableColumn="type" style="width:16%">
              <div class="flex items-center gap-2">
                  Type
                  <p-sortIcon field="type" />
              </div>
          </th>
            <th pSortableColumn="type" style="width:16%">
              <div class="flex items-center gap-2">
                  Status
                  <p-sortIcon field="type" />
              </div>
          </th>
            <th pSortableColumn="completionDate" style="width:15%">
              <div class="flex items-center gap-2">
                Completion Date
                <p-sortIcon field="completionDate" />
              </div>
            </th>

            <th pSortableColumn="assignedDate" style="width:15%">
              <div class="flex items-center gap-2">
                Assigned Date
                <p-sortIcon field="assignedDate" />
              </div>
            </th>

        </tr>
    </ng-template>
    <ng-template #body let-task>
        <tr [pSelectableRow]="task">
          <td>
            <div class="task-icons">
              <div>
                <i
                class="pi pi-thumbtack"
                [ngClass]="{ 'active-pin': task.pinned }"
                title="Pinned Task"
                (click)="togglePin(task, $event)">

              </i>

              <!-- Priority icon -->
              <i
                class="pi pi-flag"
                [ngClass]="{ 'active-priority': task.priority }"
                title="Priority Task"
                (click)="togglePriority(task, $event)">

              </i>
              </div>
             <div [routerLink]="['/tasks', task._id]"
              (click)="$event.stopPropagation()" style="flex: 1;">
                <a
                style="cursor: pointer; text-decoration: none; color: forestgreen; font: caption;"
                [title]="task.originalTitle || task.title"
              >
                {{ task.title }}

               </a>
              <span *ngIf="task.status[task.status.length - 1].value !== 'Done'"
                class="badge"
                [ngClass]="{
                  'badge-success': getTaskStatus(task._id)?.type === 'left',
                  'badge-warning': getTaskStatus(task._id)?.type === 'last',
                  'badge-danger': getTaskStatus(task._id)?.type === 'delayed'
                }">
                {{ getTaskStatus(task._id)?.text }}
              </span>
             </div>

          </div>
          </td>
          <td>
            <p-menu #taskMenu [popup]="true" [model]="taskItems" appendTo="body"></p-menu>
              <p-button
                icon="pi pi-ellipsis-v"
                styleClass="p-button-text"
                (click)="setTaskMenu(task); taskMenu.toggle($event)"
                [title]="'Actions for ' + task.title"
            ></p-button>
          </td>
          <!-- <td>
            <a
              [routerLink]="['/tasks', task._id]"
              (click)="$event.stopPropagation()"
              style="cursor: pointer; text-decoration: none; color: forestgreen; font: caption;"
              [title]="task.originalTitle || task.title"
            >
              {{ task.title }}
            </a>
          </td> -->

          <td>
            <p-tag [value]="task.type" [severity]="getSeverityType(task.type)" />
        </td>
            <td>
              <p-tag [value]="task.status[task.status.length - 1].value" [severity]="getSeverity(task.status[task.status.length - 1].value)" />
          </td>
            <td>
                {{ task.completionDate }}
            </td>
            <td>
                {{ task.assignedDate }}
            </td>


        </tr>
    </ng-template>
    <ng-template emptymessage>
        <tr>
            <td colspan="4">No customers found.</td>
        </tr>
    </ng-template>
</p-table>

<!-- Child Route Modal -->
<div class="modal-wrapper" *ngIf="childRouteActive">
  <div class="modal-content">
    <router-outlet></router-outlet>
  </div>
</div>
